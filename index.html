<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />

  <!-- Base obligatoria para GitHub Pages -->
  <base href="/control-maquinaria/">

  <title>Control de Maquinaria</title>

  <!-- iOS PWA FIXES -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Maquinaria">

  <link rel="apple-touch-icon" href="icons/icon-192.png">

  <!-- Archivos principales -->
  <link rel="stylesheet" href="style.css">
  <link rel="manifest" href="manifest.json">

  <!-- Forzar cache en iOS -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
</head>

<body>

<!-- PANTALLA DE PIN -->
<div id="lockScreen" class="centered">
  <div class="card">
    <h2>Ingresar PIN</h2>
    <input id="pinInput" type="password" placeholder="Escribe el PIN" autocomplete="off" />
    <div class="row" style="margin-top:12px;">
      <button id="unlockBtn" class="btn primary">Entrar</button>
      <button id="clearDataBtn" class="btn danger">Borrar Datos</button>
    </div>
    <p class="muted small">PIN por defecto: <code>1234</code></p>
  </div>
</div>

<!-- APP -->
<div id="app" class="hidden appshell">

  <header class="topbar">
    <h1>Control de Maquinaria</h1>
    <div class="controls">
      <button id="openHome" class="btn">üè† Inicio</button>
      <button id="openMachinesPage" class="btn">‚öôÔ∏è Maquinarias</button>
      <button id="addMachineBtn" class="btn">‚ûï Agregar m√°quina</button>
      <button id="reportBtn" class="btn">üìä Reporte semanal</button>
      <button id="exportBtn" class="btn">‚¨áÔ∏è Exportar CSV</button>
    </div>
  </header>

  <main id="homePage" class="page content">
    <section class="card">
      <h2>Registrar trabajo</h2>
      <form id="registroForm" class="grid-form">

        <label>Fecha
          <input type="date" id="fecha" required />
        </label>

        <label>Maquinaria
          <select id="maquinaria" required>
            <option value="">-- Seleccionar --</option>
          </select>
        </label>

        <div class="time-block">
          <div>
            <label>Inicio ma√±ana
              <input type="time" id="inicioM" />
            </label>
            <label>Fin ma√±ana
              <input type="time" id="finM" />
            </label>
          </div>
          <div>
            <label>Inicio tarde
              <input type="time" id="inicioT" />
            </label>
            <label>Fin tarde
              <input type="time" id="finT" />
            </label>
          </div>
        </div>

        <label>Tipo de trabajo
          <input type="text" id="tipo" placeholder="Mantenimiento, Carga..." />
        </label>

        <label>Observaciones
          <input type="text" id="obs" placeholder="Detalles (opcional)" />
        </label>

        <label>Foto (opcional)
          <input type="file" id="foto" accept="image/*" />
        </label>

        <div class="align-end">
          <b>Horas trabajadas: <span id="horasDisplay">0.00</span></b>
        </div>

        <div class="fullrow row gap">
          <button type="submit" class="btn primary">Guardar registro</button>
          <button type="button" id="resetForm" class="btn">Limpiar</button>
          <button type="button" id="exportSingleCSV" class="btn">‚¨áÔ∏è Exportar registros (CSV)</button>
        </div>

      </form>
    </section>

    <section class="card">
      <h2>Registros</h2>

      <div class="search-row">
        <div>
          <label>Fecha exacta:
            <input type="date" id="searchDateExact" />
          </label>
          <button id="searchExactBtn" class="btn">Buscar</button>
        </div>

        <div>
          <label>Rango Desde:
            <input type="date" id="searchDateFrom" />
          </label>
        </div>

        <div>
          <label>Hasta:
            <input type="date" id="searchDateTo" />
          </label>
        </div>

        <div class="row gap">
          <button id="searchRangeBtn" class="btn">Buscar rango</button>
          <button id="clearSearchBtn" class="btn">Mostrar todo</button>
        </div>
      </div>

      <div class="table-wrap">
        <table id="tabla">
          <thead>
            <tr>
              <th>Fecha</th>
              <th>Maquinaria</th>
              <th>Tipo</th>
              <th>Obs</th>
              <th>Horas</th>
              <th>Foto</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>

        <div id="noRecords" class="muted small hidden">
          No hay registros.
        </div>
      </div>

    </section>
  </main>

  <!-- P√ÅGINA MAQUINARIAS -->
  <div id="machinesPage" class="hidden page content card">
    <div class="row between">
      <h2>Maquinarias</h2>
      <div>
        <input id="buscarMaquina" type="text" placeholder="Buscar por nombre..." />
        <button id="addMachineFromPage" class="btn">‚ûï Agregar nueva m√°quina</button>
        <button id="closeMachinesPage" class="btn">Volver</button>
      </div>
    </div>

    <div id="listaMaquinas" class="list"></div>
  </div>

  <!-- MODAL -->
  <div id="machineModal" class="hidden modal">
    <div class="modal-card">
      <h3 id="machineModalTitle">Agregar Maquinaria</h3>
      <input id="newMachineName" placeholder="Nombre de la maquinaria" />
      <div class="row gap" style="margin-top:10px;">
        <button id="saveMachineBtn" class="btn primary">Guardar</button>
        <button id="closeMachineBtn" class="btn">Cerrar</button>
      </div>
    </div>
  </div>

</div>

<!-- Script principal -->
<script src="script.js" defer></script>

<!-- Service Worker REGISTRADO CORRECTAMENTE PARA iOS + GitHub Pages -->
<script>
  if ("serviceWorker" in navigator) {
    window.addEventListener("load", () => {
      navigator.serviceWorker.register("/control-maquinaria/service-worker.js", {
        scope: "/control-maquinaria/"
      });
    });
  }
</script>

</body>
</html>
